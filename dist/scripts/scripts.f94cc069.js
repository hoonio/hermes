"use strict";var app=angular.module("hoonioNewsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase"]).constant("FIREBASE_URL","https://hoonio-news.firebaseio.com/").config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/posts.html",controller:"PostsCtrl"}).when("/posts/:postId",{templateUrl:"views/showpost.html",controller:"PostViewCtrl"}).when("/users/:userId",{templateUrl:"views/profile.html",controller:"ProfiltCtrl"}).when("/register",{templateUrl:"views/register.html",controller:"AuthCtrl",resolve:{user:["Auth",function(a){return a.resolveUser()}]}}).when("/login",{templateUrl:"views/login.html",controller:"AuthCtrl",resolve:{user:["Auth",function(a){return a.resolveUser()}]}}).otherwise({redirectTo:"/"})}]);app.controller("PostsCtrl",["$scope","$location","Post","Auth",function(a,b,c,d){a.posts=c.all,a.user=d.user,a.post={url:"http://",title:""},a.deletePost=function(a){c["delete"](a)}}]),app.controller("PostViewCtrl",["$scope","$routeParams","Post","Auth",function(a,b,c,d){a.post=c.get(b.postId),a.comments=c.comments(b.postId),a.user=d.user,a.signedIn=d.signedIn,a.addComment=function(){if(a.commentText&&""!==a.commentText){var b={text:a.commentText,creator:a.user.profile.username,creatorUID:a.user.uid};a.comments.$add(b),a.commentText=""}},a.deleteComment=function(b){a.comments.$remove(b)}}]),app.controller("NavCtrl",["$scope","$location","Post","Auth",function(a,b,c,d){a.post={url:"http://",title:""},a.submitPost=function(){a.post.creator=a.user.profile.username,a.post.creatorUID=a.user.uid,c.create(a.post).then(function(c){b.path("/posts/"+c.name()),a.post={url:"http://",title:""}})},a.user=d.user,a.signedIn=d.signedIn,a.logout=d.logout}]),app.factory("Post",["$firebase","FIREBASE_URL",function(a,b){var c=new Firebase(b),d=a(c.child("posts")).$asArray();console.log(d);var e={all:d,create:function(b){return d.$add(b).then(function(d){return a(c.child("user_posts").child(b.creatorUID)).$push(d.name()),d})},get:function(b){return a(c.child("posts").child(b)).$asObject()},"delete":function(a){return d.$remove(a)},comments:function(b){return a(c.child("comments").child(b)).$asArray()}};return e}]),app.filter("hostnameFromUrl",function(){return function(a){var b=document.createElement("a");return b.href=a,b.hostname}}),app.controller("AuthCtrl",["$scope","$location","Auth","user",function(a,b,c){c.signedIn()&&b.path("/"),a.login=function(){c.login(a.user).then(function(){b.path("/")},function(b){a.error=b.toString()})},a.register=function(){c.register(a.user).then(function(d){return c.login(a.user).then(function(){return d.username=a.user.username,c.createProfile(d)}).then(function(){b.path("/")})},function(b){a.error=b.toString()})}}]),app.factory("Auth",["$firebaseSimpleLogin","FIREBASE_URL","$rootScope","$firebase",function(a,b,c,d){var e=new Firebase(b),f=a(e),g={register:function(a){return f.$createUser(a.email,a.password)},createProfile:function(a){var b={username:a.username,md5_hash:a.md5_hash},c=d(e.child("profile"));return c.$set(a.uid,b)},login:function(a){return f.$login("password",a)},logout:function(){f.$logout()},resolveUser:function(){return f.$getCurrentUser()},signedIn:function(){return!!g.user.provider},user:{}};return c.$on("$firebaseSimpleLogin:login",function(a,b){angular.copy(b,g.user),g.user.profile=d(e.child("profile").child(g.user.uid)).$asObject()}),c.$on("$firebaseSimpleLogin:logout",function(){console.log("logged out"),g.user&&g.user.profile&&g.user.profile.$destroy(),angular.copy({},g.user)}),g}]),app.factory("Profile",["$window","FIREBASE_URL","$firebase","Post","$q",function(a,b,c,d,e){var f=new a.Firebase(b),g={get:function(a){return c(f.child("profile").child(a)).$asObject()},getPosts:function(a){var b=e.defer();return $firbebase(f.child("user_posts").child(a)).$asArray().$loaded().then(function(a){for(var c={},e=0;e<a.length;e++){var f=a[e].$value;c[f]=d.get(f)}b.resolve(c)}),b.promise}};return g}]),app.controller("profileCtrl",["$scope","$routeParam","Profile",function(a,b,c){var d=$routeParams.userId;a.profile=c.get(d),c.getPosts(d).then(function(b){a.posts=b})}]);